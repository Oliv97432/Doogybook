import{r as d,j as e,k as z,N as M,O as D,H as q,K as F,G as H}from"./vendor-react-CkOypKSt.js";import{u as R,s as n}from"./index-CmpvQ7zl.js";import{T}from"./TabNavigation-U9FZqoY9.js";import{U as V}from"./UserMenu-z7rjEeqh.js";import{F as G}from"./Footer-1uazuOPJ.js";import{c as K,b as O}from"./vendor-router-M7WQPhYn.js";import"./vendor-misc-B8HVOz_X.js";import"./vendor-pdf-lazy-D4am8o_0.js";import"./vendor-supabase-DEZzVAXw.js";const se=()=>{var v,w,k,C,S;const{id:s}=K(),{user:o}=R(),l=O(),[t,m]=d.useState(null),[p,g]=d.useState([]),[b,j]=d.useState(!0),[u,i]=d.useState(!1),[c,y]=d.useState(""),[x,h]=d.useState(!1);d.useEffect(()=>{_(),f(),o&&P(),U()},[s,o]);const _=async()=>{try{const{data:r,error:a}=await n.from("forum_posts").select(`
          *,
          author:user_id (
            id,
            email,
            raw_user_meta_data
          ),
          forum:forum_id (
            id,
            name,
            slug
          ),
          images:forum_post_images (
            image_url,
            caption,
            display_order
          )
        `).eq("id",s).single();if(a)throw a;m(r)}catch(r){console.error("Erreur chargement post:",r),l("/forum-hub")}finally{j(!1)}},f=async()=>{try{const{data:r,error:a}=await n.from("forum_comments").select(`
          *,
          author:user_id (
            id,
            email,
            raw_user_meta_data
          )
        `).eq("post_id",s).is("parent_id",null).order("created_at",{ascending:!0});if(a)throw a;g(r||[])}catch(r){console.error("Erreur chargement commentaires:",r)}},P=async()=>{if(o)try{const{data:r}=await n.from("forum_likes").select("id").eq("post_id",s).eq("user_id",o.id).maybeSingle();i(!!r)}catch(r){console.error("Erreur vérification like:",r)}},U=async()=>{try{await n.rpc("increment_post_views",{post_id:s})}catch{}},L=async()=>{if(!o){l("/login");return}try{u?(await n.from("forum_likes").delete().eq("post_id",s).eq("user_id",o.id),i(!1),m(r=>({...r,like_count:r.like_count-1}))):(await n.from("forum_likes").insert({post_id:s,user_id:o.id}),i(!0),m(r=>({...r,like_count:r.like_count+1})))}catch(r){console.error("Erreur like:",r),alert("❌ Erreur lors du like")}},A=async r=>{if(r.preventDefault(),!!c.trim()){if(!o){l("/login");return}h(!0);try{const{error:a}=await n.from("forum_comments").insert({post_id:s,user_id:o.id,content:c.trim()});if(a)throw a;y(""),f(),m(E=>({...E,comment_count:E.comment_count+1}))}catch(a){console.error("Erreur création commentaire:",a),alert("❌ Erreur lors de la publication du commentaire")}finally{h(!1)}}},$=async()=>{if(confirm("Êtes-vous sûr de vouloir supprimer ce post ?"))try{const{error:r}=await n.from("forum_posts").delete().eq("id",s);if(r)throw r;alert("✅ Post supprimé"),l(`/forum/${t.forum.slug}`)}catch(r){console.error("Erreur suppression post:",r),alert("❌ Erreur lors de la suppression")}};if(b)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})});if(!t)return null;const N=((w=(v=t.author)==null?void 0:v.raw_user_meta_data)==null?void 0:w.full_name)||((C=(k=t.author)==null?void 0:k.email)==null?void 0:C.split("@")[0])||"Utilisateur",I=r=>new Date(r).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("div",{className:"sticky top-0 z-50 bg-card border-b border-border shadow-soft",children:e.jsx("div",{className:"max-w-screen-xl mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("button",{onClick:()=>l(`/forum/${t.forum.slug}`),className:"text-muted-foreground hover:text-foreground",children:["← ",t.forum.name]}),e.jsx(V,{})]})})}),e.jsx(T,{}),e.jsx("main",{className:"main-content",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6",children:[e.jsxs("div",{className:"bg-card border border-border rounded-3xl p-6 mb-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold",children:N.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:N}),t.is_expert_post&&e.jsx(z,{size:16,className:"text-yellow-500",title:"Expert"})]}),e.jsx("span",{className:"text-sm text-muted-foreground",children:I(t.created_at)})]})]}),(o==null?void 0:o.id)===t.user_id&&e.jsxs("div",{className:"relative group",children:[e.jsx("button",{className:"p-2 hover:bg-muted rounded-xl transition-smooth",children:e.jsx(M,{size:20})}),e.jsx("div",{className:"absolute right-0 mt-2 w-48 bg-card border border-border rounded-xl shadow-elevated hidden group-hover:block",children:e.jsxs("button",{onClick:$,className:"w-full flex items-center gap-2 px-4 py-2 hover:bg-destructive/10 text-destructive rounded-xl",children:[e.jsx(D,{size:16}),"Supprimer"]})})]})]}),t.category&&e.jsx("span",{className:"inline-block px-3 py-1 bg-primary/10 text-primary text-sm font-medium rounded-full mb-4",children:t.category}),e.jsx("h1",{className:"text-2xl font-heading font-bold mb-4",children:t.title}),e.jsx("div",{className:"prose prose-sm max-w-none mb-6",children:e.jsx("p",{className:"whitespace-pre-wrap text-foreground",children:t.content})}),t.images&&t.images.length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:t.images.sort((r,a)=>r.display_order-a.display_order).map((r,a)=>e.jsxs("div",{children:[e.jsx("img",{src:r.image_url,alt:r.caption||"",className:"w-full rounded-2xl object-cover"}),r.caption&&e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:r.caption})]},a))}),e.jsxs("div",{className:"flex items-center gap-6 pt-4 border-t border-border",children:[e.jsxs("button",{onClick:L,className:`flex items-center gap-2 px-4 py-2 rounded-xl font-medium transition-smooth ${u?"bg-red-100 text-red-600":"hover:bg-muted"}`,children:[e.jsx(q,{size:20,fill:u?"currentColor":"none"}),e.jsx("span",{children:t.like_count||0})]}),e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(F,{size:20}),e.jsxs("span",{children:[t.comment_count||0," commentaires"]})]})]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-3xl p-6",children:[e.jsxs("h2",{className:"text-xl font-heading font-bold mb-6",children:["Commentaires (",p.length,")"]}),o?e.jsx("form",{onSubmit:A,className:"mb-6",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold flex-shrink-0",children:(S=o.email)==null?void 0:S.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1",children:[e.jsx("textarea",{value:c,onChange:r=>y(r.target.value),placeholder:"Écrivez un commentaire...",rows:3,className:"w-full px-4 py-3 border border-border rounded-xl focus:ring-2 focus:ring-primary resize-none mb-2"}),e.jsxs("button",{type:"submit",disabled:!c.trim()||x,className:"px-4 py-2 bg-primary text-primary-foreground rounded-xl font-medium hover:bg-primary/90 transition-smooth disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2",children:[e.jsx(H,{size:16}),x?"Publication...":"Publier"]})]})]})}):e.jsxs("div",{className:"bg-muted rounded-xl p-6 text-center mb-6",children:[e.jsx("p",{className:"text-muted-foreground mb-3",children:"Connectez-vous pour commenter"}),e.jsx("button",{onClick:()=>l("/login"),className:"px-6 py-2 bg-primary text-primary-foreground rounded-xl font-medium hover:bg-primary/90 transition-smooth",children:"Se connecter"})]}),e.jsxs("div",{className:"space-y-4",children:[p.map(r=>e.jsx(B,{comment:r,currentUserId:o==null?void 0:o.id,onDelete:()=>f()},r.id)),p.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"Aucun commentaire pour le moment. Soyez le premier à commenter !"})]})]})]})}),e.jsx(G,{})]})},B=({comment:s,currentUserId:o,onDelete:l})=>{var g,b,j,u;const t=((b=(g=s.author)==null?void 0:g.raw_user_meta_data)==null?void 0:b.full_name)||((u=(j=s.author)==null?void 0:j.email)==null?void 0:u.split("@")[0])||"Utilisateur",m=i=>{const c=new Date(i),x=new Date-c,h=Math.floor(x/6e4),_=Math.floor(x/36e5),f=Math.floor(x/864e5);return h<60?`Il y a ${h} min`:_<24?`Il y a ${_}h`:f<7?`Il y a ${f}j`:c.toLocaleDateString("fr-FR")},p=async()=>{if(confirm("Supprimer ce commentaire ?"))try{const{error:i}=await n.from("forum_comments").delete().eq("id",s.id);if(i)throw i;l()}catch(i){console.error("Erreur suppression commentaire:",i),alert("❌ Erreur lors de la suppression")}};return e.jsxs("div",{className:"flex gap-3 p-4 rounded-xl hover:bg-muted/50 transition-smooth",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-blue-600 flex items-center justify-center text-white font-bold flex-shrink-0",children:t.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:t}),s.is_expert_comment&&e.jsx(z,{size:14,className:"text-yellow-500",title:"Expert"}),e.jsx("span",{className:"text-muted-foreground text-sm",children:m(s.created_at)})]}),o===s.user_id&&e.jsx("button",{onClick:p,className:"text-muted-foreground hover:text-destructive",children:e.jsx(D,{size:16})})]}),e.jsx("p",{className:"text-foreground whitespace-pre-wrap",children:s.content}),s.like_count>0&&e.jsxs("div",{className:"flex items-center gap-1 mt-2 text-sm text-muted-foreground",children:[e.jsx(q,{size:14}),e.jsx("span",{children:s.like_count})]})]})]})};export{se as default};
