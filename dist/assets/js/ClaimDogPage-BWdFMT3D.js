import{u as R,s as n,j as e}from"./index-B7Jx57M6.js";import{f as B,d as F,r as i}from"./vendor-react-DEK6ZklB.js";import{u as f,i as H,q as U,H as V}from"./vendor-ui-BmzNxrw7.js";import"./vendor-supabase-DfwcnzK-.js";const Q=()=>{var j,w,_,N,v;const[z]=B(),d=F(),{user:a}=R(),o=z.get("token"),[D,u]=i.useState(!0),[t,q]=i.useState(null),[g,r]=i.useState(""),[h,p]=i.useState(!1),[b,$]=i.useState(!1);i.useEffect(()=>{if(!o){r("Token manquant"),u(!1);return}L()},[o]),i.useEffect(()=>{a&&t&&!h&&!b&&P()},[a,t]);const L=async()=>{u(!0),r("");try{const{data:s,error:m}=await n.from("pending_transfers").select("*").eq("transfer_token",o).single();if(m)throw m;if(!s){r("Transfert introuvable");return}if(s.status==="completed"){r("Ce transfert a d√©j√† √©t√© effectu√©");return}if(s.status==="expired"){r("Ce lien de transfert a expir√© (>7 jours)");return}if(s.status==="cancelled"){r("Ce transfert a √©t√© annul√©");return}if(new Date(s.expires_at)<new Date){r("Ce lien de transfert a expir√©"),await n.from("pending_transfers").update({status:"expired"}).eq("id",s.id);return}q(s)}catch(s){console.error("Erreur chargement transfert:",s),r("Erreur lors du chargement du transfert")}finally{u(!1)}},P=async()=>{var m,x;if(!a){d(`/login?redirect=/claim-dog?token=${o}`);return}p(!0),r("");try{const c=(m=a.email)==null?void 0:m.toLowerCase(),T=t.to_email.toLowerCase();if(c!==T){r(`Ce transfert est destin√© √† ${t.to_email}, pas √† ${a.email}`);return}const{data:l,error:y}=await n.from("dogs").select("*").eq("id",t.dog_id).single();if(y)throw y;if(!l){r("Le chien n'existe plus");return}const{data:A,error:O}=await n.from("user_profiles").select("id").eq("email",c).single();if(O){const{data:I,error:S}=await n.from("user_profiles").insert({user_id:a.id,email:c,full_name:((x=a.user_metadata)==null?void 0:x.full_name)||null,created_at:new Date().toISOString()}).select("id").single();if(S)throw S;var s=I.id}else var s=A.id;const{error:C}=await n.from("dogs").update({user_id:s,professional_account_id:null,is_for_adoption:!1,adoption_status:"adopted",updated_at:new Date().toISOString()}).eq("id",t.dog_id);if(C)throw C;const{error:k}=await n.from("pending_transfers").update({status:"completed",completed_at:new Date().toISOString()}).eq("id",t.id);k&&console.error("Erreur marquage transfert:",k);const{error:E}=await n.from("notifications").insert({user_id:s,type:"dog_received",title:`üéâ Bienvenue ${l.name} !`,message:`${l.name} a √©t√© transf√©r√© avec succ√®s sur votre compte. Vous pouvez maintenant g√©rer son profil de sant√©.`,data:{dog_id:l.id,dog_name:l.name},created_at:new Date().toISOString()});E&&console.error("Erreur notification:",E),$(!0),setTimeout(()=>{d(`/dog-profile/${l.id}`)},3e3)}catch(c){console.error("Erreur r√©cup√©ration chien:",c),r("Erreur lors de la r√©cup√©ration du chien")}finally{p(!1)}};return D?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(f,{className:"animate-spin h-12 w-12 text-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 text-sm sm:text-base",children:"Chargement..."})]})}):g?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white rounded-2xl sm:rounded-3xl shadow-lg p-6 sm:p-8 text-center",children:[e.jsx("div",{className:"w-16 h-16 sm:w-20 sm:h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(H,{className:"text-red-600 size-8 sm:size-10"})}),e.jsx("h2",{className:"text-xl sm:text-2xl font-heading font-bold text-gray-900 mb-2 leading-tight",children:"Oups !"}),e.jsx("p",{className:"text-gray-600 mb-6 text-sm sm:text-base break-words",children:g}),e.jsx("button",{onClick:()=>d("/"),className:"px-4 sm:px-6 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 transition-smooth min-h-[44px] text-sm sm:text-base",children:"Retour √† l'accueil"})]})}):b?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white rounded-2xl sm:rounded-3xl shadow-lg p-6 sm:p-8 text-center",children:[e.jsx("div",{className:"w-16 h-16 sm:w-20 sm:h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(U,{className:"text-green-600 size-8 sm:size-10"})}),e.jsx("h2",{className:"text-xl sm:text-2xl font-heading font-bold text-gray-900 mb-2 leading-tight",children:"üéâ F√©licitations !"}),e.jsxs("p",{className:"text-gray-600 mb-6 text-sm sm:text-base",children:[(j=t.dog_data)==null?void 0:j.name," a √©t√© transf√©r√© avec succ√®s sur votre compte !"]}),e.jsx("div",{className:"bg-blue-50 p-3 sm:p-4 rounded-xl text-xs sm:text-sm text-blue-900 mb-6",children:e.jsxs("p",{children:["Redirection vers le profil de ",(w=t.dog_data)==null?void 0:w.name,"..."]})}),e.jsxs("div",{className:"animate-pulse text-blue-500 text-sm",children:[e.jsx(f,{className:"inline animate-spin h-4 w-4 mr-2"}),"Patientez un instant..."]})]})}):a?h?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(f,{className:"animate-spin h-12 w-12 text-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 text-sm sm:text-base",children:"Transfert en cours..."}),e.jsxs("p",{className:"text-gray-500 text-xs mt-2",children:["Patientez, ",(v=t==null?void 0:t.dog_data)==null?void 0:v.name," arrive bient√¥t !"]})]})}):null:e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white rounded-2xl sm:rounded-3xl shadow-lg p-4 sm:p-6 md:p-8",children:[t.dog_data&&e.jsxs("div",{className:"text-center mb-6",children:[t.dog_data.photo_url?e.jsx("img",{src:t.dog_data.photo_url,alt:t.dog_data.name,className:"w-24 h-24 sm:w-32 sm:h-32 rounded-2xl sm:rounded-3xl object-cover mx-auto mb-4 shadow-lg"}):e.jsx("div",{className:"w-24 h-24 sm:w-32 sm:h-32 rounded-2xl sm:rounded-3xl bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center mx-auto mb-4 text-white text-3xl sm:text-4xl font-bold",children:(_=t.dog_data.name)==null?void 0:_.charAt(0).toUpperCase()}),e.jsxs("h2",{className:"text-lg sm:text-xl md:text-2xl font-heading font-bold text-gray-900 mb-2 leading-tight",children:[t.dog_data.name," vous attend ! üêï"]}),e.jsxs("p",{className:"text-gray-600 text-sm sm:text-base truncate",children:[t.dog_data.breed," ‚Ä¢ ",t.dog_data.age]})]}),e.jsx("div",{className:"bg-blue-50 border-l-4 border-blue-500 p-3 sm:p-4 rounded-r-xl mb-4 sm:mb-6",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(V,{className:"text-blue-600 flex-shrink-0 size-5 sm:size-6"}),e.jsxs("div",{className:"text-xs sm:text-sm text-blue-900",children:[e.jsx("p",{className:"font-semibold mb-1",children:"Un chien a √©t√© transf√©r√© pour vous !"}),e.jsxs("p",{className:"break-words",children:["Connectez-vous ou cr√©ez un compte avec l'adresse ",e.jsx("strong",{className:"break-all",children:t.to_email})," pour r√©cup√©rer ",(N=t.dog_data)==null?void 0:N.name,"."]})]})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>d(`/login?redirect=/claim-dog?token=${o}`),className:"w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 sm:px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 transition-all min-h-[52px] text-sm sm:text-base",children:"Se connecter"}),e.jsx("button",{onClick:()=>d(`/register?redirect=/claim-dog?token=${o}`),className:"w-full border-2 border-blue-500 text-blue-600 px-4 sm:px-6 py-3 rounded-xl font-semibold hover:bg-blue-50 transition-smooth min-h-[52px] text-sm sm:text-base",children:"Cr√©er un compte"})]}),e.jsxs("p",{className:"text-xs text-gray-500 text-center mt-4 sm:mt-6",children:["‚è∞ Ce lien expire le ",new Date(t.expires_at).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})]})]})})};export{Q as default};
