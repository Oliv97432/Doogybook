import{u as I,s as m,j as e,I as p}from"./index-CXgzQAJL.js";import{d as q,r as i}from"./vendor-react-DEK6ZklB.js";import{F as A}from"./Footer-CUAdwqST.js";import{S as G}from"./SubscriptionBadge-DWPLiFTV.js";import"./vendor-ui-Bo32stKt.js";import"./vendor-supabase-DfwcnzK-.js";const V=()=>{const v=q(),{user:r}=I(),[C,j]=i.useState(!0),[N,y]=i.useState(!1),[P,w]=i.useState(!1),[z,_]=i.useState("free"),[s,x]=i.useState({fullName:"",email:"",phone:"",zipcode:"",avatarUrl:""}),[d,f]=i.useState(null),[U,h]=i.useState(null);i.useEffect(()=>{S()},[r]);const S=async()=>{var t,o,l,n,c,u;try{j(!0);const{data:a,error:g}=await m.from("user_profiles").select("*").eq("id",r==null?void 0:r.id).single();if(g&&g.code!=="PGRST116")throw g;x({fullName:(a==null?void 0:a.full_name)||((t=r==null?void 0:r.user_metadata)==null?void 0:t.full_name)||"",email:(r==null?void 0:r.email)||"",phone:(a==null?void 0:a.phone)||((o=r==null?void 0:r.user_metadata)==null?void 0:o.phone)||"",zipcode:(a==null?void 0:a.location)||((l=r==null?void 0:r.user_metadata)==null?void 0:l.location)||"",avatarUrl:(a==null?void 0:a.avatar_url)||""}),h((a==null?void 0:a.avatar_url)||null),_((a==null?void 0:a.subscription_tier)||"free")}catch(a){console.error("Erreur chargement profil:",a),x({fullName:((n=r==null?void 0:r.user_metadata)==null?void 0:n.full_name)||"",email:(r==null?void 0:r.email)||"",phone:((c=r==null?void 0:r.user_metadata)==null?void 0:c.phone)||"",zipcode:((u=r==null?void 0:r.user_metadata)==null?void 0:u.location)||"",avatarUrl:""}),_("free")}finally{j(!1)}},b=(t,o)=>{x(l=>({...l,[t]:o}))},k=t=>{var n;const o=(n=t.target.files)==null?void 0:n[0];if(!o)return;if(!o.type.startsWith("image/")){alert("Veuillez sélectionner une image valide.");return}if(o.size>5*1024*1024){alert("L'image ne doit pas dépasser 5 MB.");return}f(o);const l=new FileReader;l.onload=c=>{var u;h((u=c.target)==null?void 0:u.result)},l.readAsDataURL(o)},E=()=>{f(null),h(s.avatarUrl||null)},F=async()=>{if(!d)return s.avatarUrl;try{const t=d.name.split(".").pop(),o=`${r==null?void 0:r.id}/${Date.now()}.${t}`,{data:l,error:n}=await m.storage.from("user-avatars").upload(o,d,{cacheControl:"3600",upsert:!1});if(n)throw n;const{data:c}=m.storage.from("user-avatars").getPublicUrl(o);return c.publicUrl}catch(t){return console.error("Erreur upload photo:",t),alert("Erreur lors de l'upload de la photo."),s.avatarUrl}},D=async t=>{if(t.preventDefault(),!s.fullName.trim()){alert("Le nom complet est requis.");return}try{y(!0),w(!!d);const o=await F(),{error:l}=await m.from("user_profiles").update({full_name:s.fullName.trim(),phone:s.phone.trim()||null,location:s.zipcode.trim()||null,avatar_url:o||null,updated_at:new Date().toISOString()}).eq("id",r==null?void 0:r.id);if(l)throw l;const{error:n}=await m.auth.updateUser({data:{full_name:s.fullName.trim(),avatar_url:o||null}});if(n)throw n;alert("✅ Profil mis à jour avec succès !"),f(null),await S()}catch(o){console.error("Erreur sauvegarde profil:",o),alert("Erreur lors de la sauvegarde. Veuillez réessayer.")}finally{y(!1),w(!1)}},L=s.fullName.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)||"U";return C?e.jsx("div",{className:"min-h-screen bg-brand-bg flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Chargement du profil..."})]})}):e.jsxs("div",{className:"min-h-screen bg-brand-bg pb-20 pt-4 px-4",children:[e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:()=>v(-1),className:"p-2 hover:bg-muted rounded-full transition-smooth",children:e.jsx(p,{name:"ArrowLeft",size:24,className:"text-foreground"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-2xl font-heading font-bold text-foreground",children:"Mon profil"}),e.jsx(G,{tier:z,size:"sm"})]})]}),e.jsxs("form",{onSubmit:D,className:"space-y-6",children:[e.jsxs("div",{className:"bg-card rounded-3xl p-6 shadow-soft border border-border",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground mb-4",children:"Photo de profil"}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-6",children:[e.jsxs("div",{className:"relative",children:[U?e.jsx("img",{src:U,alt:"Profil",className:"w-32 h-32 rounded-full object-cover border-4 border-border"}):e.jsx("div",{className:"w-32 h-32 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-4xl font-bold border-4 border-border",children:L}),d&&e.jsx("button",{type:"button",onClick:E,className:"absolute -top-2 -right-2 w-8 h-8 bg-destructive text-white rounded-full flex items-center justify-center hover:bg-destructive/90 transition-smooth",children:e.jsx(p,{name:"X",size:16})})]}),e.jsxs("div",{className:"flex-1 text-center sm:text-left",children:[e.jsxs("label",{className:"inline-block",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:k,className:"hidden"}),e.jsxs("div",{className:"px-4 py-2 bg-primary text-primary-foreground rounded-xl cursor-pointer hover:bg-primary/90 transition-smooth inline-flex items-center gap-2",children:[e.jsx(p,{name:"Upload",size:20}),e.jsx("span",{className:"font-medium",children:d?"Changer la photo":"Choisir une photo"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"JPG, PNG ou GIF - Max 5 MB"})]})]})]}),e.jsxs("div",{className:"bg-card rounded-3xl p-6 shadow-soft border border-border",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground mb-4",children:"Informations personnelles"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-foreground mb-1.5",children:["Nom complet ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx("input",{type:"text",value:s.fullName,onChange:t=>b("fullName",t.target.value),placeholder:"Jean Dupont",required:!0,className:"w-full px-4 py-2.5 border border-border rounded-xl bg-background text-foreground placeholder-muted-foreground focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-smooth"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-foreground mb-1.5",children:"Email"}),e.jsx("input",{type:"email",value:s.email,disabled:!0,className:"w-full px-4 py-2.5 border border-border rounded-xl bg-muted text-muted-foreground cursor-not-allowed"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"L'email ne peut pas être modifié"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-foreground mb-1.5",children:"Téléphone"}),e.jsx("input",{type:"tel",value:s.phone,onChange:t=>b("phone",t.target.value),placeholder:"06 12 34 56 78",className:"w-full px-4 py-2.5 border border-border rounded-xl bg-background text-foreground placeholder-muted-foreground focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-smooth"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-foreground mb-1.5",children:"Code postal"}),e.jsx("input",{type:"text",value:s.zipcode,onChange:t=>b("zipcode",t.target.value),placeholder:"75001",pattern:"[0-9]{5}",maxLength:5,className:"w-full px-4 py-2.5 border border-border rounded-xl bg-background text-foreground placeholder-muted-foreground focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-smooth"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Pour trouver des services vétérinaires près de chez vous"})]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>v(-1),className:"flex-1 px-6 py-3 border border-border rounded-xl font-medium text-foreground hover:bg-muted transition-smooth",children:"Annuler"}),e.jsx("button",{type:"submit",disabled:N,className:"flex-1 px-6 py-3 bg-primary text-primary-foreground rounded-xl font-medium hover:bg-primary/90 transition-smooth disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:P?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Upload..."})]}):N?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Sauvegarde..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(p,{name:"Check",size:20}),e.jsx("span",{children:"Enregistrer"})]})})]})]})]}),e.jsx(A,{})]})};export{V as default};
